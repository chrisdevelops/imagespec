// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String       @id @default(cuid())
  email         String       @unique
  name          String?
  passwordHash  String?      // Nullable for magic link only users
  
  // Subscription & Usage
  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?   @unique
  subscriptionTier       String    @default("free") // "free" | "pro"
  subscriptionStatus     String?   // "active" | "canceled" | "past_due"
  currentPeriodStart     DateTime?
  currentPeriodEnd       DateTime?
  imagesUsedThisPeriod   Int       @default(0)
  
  // Timestamps
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  // Relations
  collections   Collection[]
  magicLinks    MagicLink[]
  
  @@map("users")
}

model MagicLink {
  id        String   @id @default(cuid())
  token     String   @unique
  email     String
  expiresAt DateTime
  used      Boolean  @default(false)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@index([token])
  @@index([email])
  @@map("magic_links")
}

model Collection {
  id          String   @id @default(cuid())
  name        String
  description String?
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  images      Image[]
  
  @@index([userId])
  @@map("collections")
}

model Image {
  id           String   @id @default(cuid())
  
  // File info
  originalName String
  s3Key        String   @unique
  cdnUrl       String
  fileSize     Int      // in bytes
  mimeType     String
  
  // Processing status
  status       String   @default("processing") // "processing" | "completed" | "failed"
  errorMessage String?
  
  // Relations
  collectionId String
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  // Metadata (one-to-one)
  metadata     ImageMetadata?
  
  @@index([collectionId])
  @@index([status])
  @@map("images")
}

model ImageMetadata {
  id        String   @id @default(cuid())
  
  imageId   String   @unique
  image     Image    @relation(fields: [imageId], references: [id], onDelete: Cascade)
  
  // Descriptive metadata
  description      String
  altText          String
  contentKeywords  String[]
  
  // Visual analysis
  dominantColors   Json     // Array of { hex: string, percentage: number }
  paletteMood      String   // "warm" | "cool" | "neutral" | "vibrant"
  overallTone      String   // "light" | "mid" | "dark"
  width            Int
  height           Int
  aspectRatio      String
  orientation      String   // "landscape" | "portrait" | "square"
  
  // Style & mood
  styleTags        String[]
  mood             String[]
  visualWeight     String   // "light" | "medium" | "heavy"
  formalityLevel   String   // "casual" | "semi-formal" | "formal" | "luxury"
  
  // Compositional data
  focalPoint           String   // "center" | "left" | "right" | "top" | "bottom" | "distributed"
  subjectType          String   // "person" | "product" | "landscape" | "abstract" etc.
  backgroundComplexity String   // "simple" | "moderate" | "complex"
  negativeSpace        String   // "minimal" | "moderate" | "abundant"
  
  // Functional metadata
  textOverlaySafe  Boolean
  safeTextZones    String[]
  suggestedUseCases String[]
  textContent      String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@map("image_metadata")
}